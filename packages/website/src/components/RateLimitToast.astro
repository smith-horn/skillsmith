---
/**
 * Rate Limit Toast Component
 * SMI-2150: 429 toast error design
 *
 * Displays a toast notification when rate limit is exceeded.
 * Auto-hides after countdown based on retry-after header.
 */
---

<!-- Toast Container -->
<div
  id="rate-limit-toast"
  class="fixed bottom-4 right-4 z-50 max-w-sm transform translate-x-full opacity-0 transition-all duration-300 ease-out pointer-events-none"
  role="alert"
  aria-live="polite"
  aria-atomic="true"
>
  <div class="bg-dark-900 border border-yellow-500/50 rounded-xl shadow-lg p-4">
    <div class="flex items-start gap-3">
      <!-- Warning Icon -->
      <div class="flex-shrink-0">
        <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
          ></path>
        </svg>
      </div>

      <!-- Content -->
      <div class="flex-1 min-w-0">
        <p class="text-sm font-medium text-white">Rate Limit Exceeded</p>
        <p id="rate-limit-message" class="text-sm text-dark-400 mt-1">
          Too many requests. Please wait before trying again.
        </p>
        <p id="rate-limit-countdown" class="text-xs text-yellow-400 mt-2 font-mono">
          <!-- Countdown timer -->
        </p>
      </div>

      <!-- Close Button -->
      <button
        id="rate-limit-close"
        class="flex-shrink-0 text-dark-500 hover:text-white transition-colors"
        aria-label="Dismiss notification"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Progress Bar -->
    <div class="mt-3 h-1 bg-dark-700 rounded-full overflow-hidden">
      <div
        id="rate-limit-progress"
        class="h-full bg-yellow-500 transition-all duration-1000 ease-linear"
        style="width: 100%"
      >
      </div>
    </div>
  </div>
</div>

<script is:inline>
  // Rate Limit Toast Controller
  ;(function () {
    const toast = document.getElementById('rate-limit-toast')
    const message = document.getElementById('rate-limit-message')
    const countdown = document.getElementById('rate-limit-countdown')
    const progress = document.getElementById('rate-limit-progress')
    const closeBtn = document.getElementById('rate-limit-close')

    let countdownInterval = null
    let hideTimeout = null

    // Show toast with retry-after countdown
    window.showRateLimitToast = function (retryAfterSeconds, tierMessage) {
      if (!toast) return

      // Clear any existing timers
      if (countdownInterval) clearInterval(countdownInterval)
      if (hideTimeout) clearTimeout(hideTimeout)

      // Set message based on tier
      if (tierMessage) {
        message.textContent = tierMessage
      } else {
        message.textContent = 'Too many requests. Please wait before trying again.'
      }

      // Show toast
      toast.classList.remove('translate-x-full', 'opacity-0', 'pointer-events-none')

      // Start countdown
      let remaining = retryAfterSeconds || 60
      const total = remaining

      function updateCountdown() {
        if (remaining <= 0) {
          hideToast()
          return
        }

        const minutes = Math.floor(remaining / 60)
        const seconds = remaining % 60
        countdown.textContent =
          minutes > 0 ? `Try again in ${minutes}m ${seconds}s` : `Try again in ${seconds}s`

        // Update progress bar
        const percent = (remaining / total) * 100
        progress.style.width = `${percent}%`

        remaining--
      }

      updateCountdown()
      countdownInterval = setInterval(updateCountdown, 1000)

      // Auto-hide after countdown + 2s buffer
      hideTimeout = setTimeout(hideToast, (retryAfterSeconds + 2) * 1000)
    }

    // Hide toast
    function hideToast() {
      if (!toast) return

      if (countdownInterval) clearInterval(countdownInterval)
      if (hideTimeout) clearTimeout(hideTimeout)

      toast.classList.add('translate-x-full', 'opacity-0', 'pointer-events-none')
    }

    window.hideRateLimitToast = hideToast

    // Close button handler
    if (closeBtn) {
      closeBtn.addEventListener('click', hideToast)
    }

    // Intercept 429 responses globally
    const originalFetch = window.fetch
    window.fetch = async function (...args) {
      const response = await originalFetch.apply(this, args)

      if (response.status === 429) {
        const retryAfter = parseInt(response.headers.get('Retry-After') || '60', 10)
        const tierHeader = response.headers.get('X-Tier')

        let tierMessage = null
        if (tierHeader) {
          tierMessage = `Rate limit exceeded for ${tierHeader} tier. Upgrade for higher limits.`
        }

        window.showRateLimitToast(retryAfter, tierMessage)
      }

      return response
    }
  })()
</script>
