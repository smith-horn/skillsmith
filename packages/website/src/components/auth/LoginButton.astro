---
/**
 * LoginButton Component
 *
 * SMI-1715: GitHub OAuth authentication
 *
 * Renders a GitHub login button that initiates OAuth flow.
 * Can be used standalone or within the header navigation.
 */

interface Props {
  /**
   * Button variant: 'primary' for prominent display, 'secondary' for nav
   */
  variant?: 'primary' | 'secondary'
  /**
   * Optional redirect URL after login
   */
  redirectTo?: string
  /**
   * Button size
   */
  size?: 'sm' | 'md' | 'lg'
}

const { variant = 'primary', redirectTo = '/account', size = 'md' } = Astro.props

// Generate unique ID for this button instance
const buttonId = `github-login-${Math.random().toString(36).substring(2, 9)}`
---

<button
  id={buttonId}
  type="button"
  class:list={['github-login-btn', `variant-${variant}`, `size-${size}`]}
  data-redirect={redirectTo}
>
  <!-- GitHub Logo SVG -->
  <svg class="github-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
    <path
      fill-rule="evenodd"
      clip-rule="evenodd"
      d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.604-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.464-1.11-1.464-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.115 2.504.337 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z"
    ></path>
  </svg>
  <span class="btn-text">Continue with GitHub</span>
  <span class="btn-loading" style="display: none;">
    <svg class="spinner" viewBox="0 0 24 24">
      <circle
        cx="12"
        cy="12"
        r="10"
        stroke="currentColor"
        stroke-width="4"
        fill="none"
        opacity="0.25"></circle>
      <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" fill="none"></path>
    </svg>
    Connecting...
  </span>
</button>

<style>
  .github-login-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-weight: 600;
    text-decoration: none;
    border-radius: 0.5rem;
    transition: all 0.2s;
    cursor: pointer;
    border: none;
    font-family: inherit;
  }

  /* Variants */
  .variant-primary {
    background: #24292e;
    color: white;
    border: 1px solid #24292e;
  }

  .variant-primary:hover {
    background: #1b1f23;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .variant-secondary {
    background: transparent;
    color: #fafafa;
    border: 1px solid #2a2a2f;
  }

  .variant-secondary:hover {
    border-color: #24292e;
    background: rgba(36, 41, 46, 0.1);
  }

  /* Sizes */
  .size-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.8125rem;
  }

  .size-md {
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
  }

  .size-lg {
    padding: 1rem 2rem;
    font-size: 1.125rem;
  }

  /* GitHub icon */
  .github-icon {
    flex-shrink: 0;
  }

  .size-sm .github-icon {
    width: 1rem;
    height: 1rem;
  }

  .size-md .github-icon {
    width: 1.25rem;
    height: 1.25rem;
  }

  .size-lg .github-icon {
    width: 1.5rem;
    height: 1.5rem;
  }

  /* Loading state */
  .github-login-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }

  .spinner {
    width: 1.25rem;
    height: 1.25rem;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }
</style>

<script>
  import { createClient } from '@supabase/supabase-js'

  // UA hint for known in-app browsers that swallow OAuth redirects (SMI-2757)
  function isInAppBrowser(): boolean {
    return /LinkedIn|FBAN|FBAV|Instagram|Twitter\/|twttr/i.test(navigator.userAgent)
  }

  // Inject a sticky bottom banner with a copyable OAuth URL.
  // Inline styles are intentional — the element is created dynamically at runtime.
  function showInAppBrowserBanner(url: string): void {
    document.getElementById('ib-banner')?.remove()

    const banner = document.createElement('div')
    banner.id = 'ib-banner'
    banner.setAttribute(
      'style',
      'position:fixed;bottom:0;left:0;right:0;z-index:9999;' +
        'background:#1a1a1f;border-top:1px solid #2a2a2f;' +
        'padding:1rem 1.25rem;display:flex;flex-direction:column;gap:0.625rem;' +
        'font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif'
    )

    const safeUrl = url.replace(/"/g, '&quot;')
    banner.innerHTML =
      '<p style="margin:0;color:#fafafa;font-size:0.875rem;line-height:1.4">' +
      '<strong>In-app browsers may block GitHub sign-in.</strong> ' +
      'Copy the link and open it in Safari or Chrome.</p>' +
      '<div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap">' +
      '<input id="ib-url" value="' +
      safeUrl +
      '" readonly ' +
      'style="flex:1;min-width:0;background:#0d0d0f;border:1px solid #2a2a2f;' +
      'border-radius:0.375rem;padding:0.5rem 0.75rem;color:#9ca3af;' +
      'font-size:0.75rem;font-family:monospace" />' +
      '<button id="ib-copy" style="flex-shrink:0;background:#e07a5f;color:#fff;border:none;' +
      'border-radius:0.375rem;padding:0.5rem 1rem;font-size:0.875rem;font-weight:600;cursor:pointer">' +
      'Copy link</button>' +
      '<button id="ib-dismiss" style="flex-shrink:0;background:transparent;color:#9ca3af;' +
      'border:1px solid #2a2a2f;border-radius:0.375rem;padding:0.5rem 0.75rem;' +
      'font-size:0.875rem;cursor:pointer">Dismiss</button>' +
      '</div>'

    document.body.appendChild(banner)

    document.getElementById('ib-copy')?.addEventListener('click', async () => {
      const copyBtn = document.getElementById('ib-copy') as HTMLButtonElement
      try {
        await navigator.clipboard.writeText(url)
        copyBtn.textContent = 'Copied!'
        setTimeout(() => {
          copyBtn.textContent = 'Copy link'
        }, 2000)
      } catch {
        // Fallback: select input text for manual copy
        ;(document.getElementById('ib-url') as HTMLInputElement | null)?.select()
      }
    })

    document.getElementById('ib-dismiss')?.addEventListener('click', () => {
      banner.remove()
    })
  }

  function resetButton(btn: HTMLButtonElement): void {
    const btnText = btn.querySelector('.btn-text') as HTMLSpanElement | null
    const btnLoading = btn.querySelector('.btn-loading') as HTMLSpanElement | null
    if (btnText) btnText.style.display = 'inline'
    if (btnLoading) btnLoading.style.display = 'none'
    btn.disabled = false
  }

  // Initialize all GitHub login buttons on the page
  document.querySelectorAll('.github-login-btn').forEach((button) => {
    button.addEventListener('click', async (e) => {
      const btn = e.currentTarget as HTMLButtonElement
      const redirectTo = btn.dataset.redirect || '/account'

      // Get config from global
      const config = (
        window as unknown as { __SUPABASE_CONFIG__?: { url: string; anonKey: string } }
      ).__SUPABASE_CONFIG__
      if (!config?.url || !config?.anonKey) {
        console.error('Supabase config not found — check __SUPABASE_CONFIG__ injection')
        return
      }

      // Show loading state
      const btnText = btn.querySelector('.btn-text') as HTMLSpanElement
      const btnLoading = btn.querySelector('.btn-loading') as HTMLSpanElement
      btnText.style.display = 'none'
      btnLoading.style.display = 'inline-flex'
      btn.disabled = true

      try {
        const supabase = createClient(config.url, config.anonKey)

        // Fetch OAuth URL without immediately redirecting so we can inspect it
        // and use it in the fallback banner if the redirect is swallowed (SMI-2757)
        const { data, error } = await supabase.auth.signInWithOAuth({
          provider: 'github',
          options: {
            redirectTo: `${window.location.origin}/auth/callback?redirect=${encodeURIComponent(redirectTo)}`,
            scopes: 'read:user user:email',
            skipBrowserRedirect: true,
          },
        })

        if (error) throw error
        if (!data?.url) throw new Error('No OAuth URL returned')

        // In-app browser detected: show copy banner immediately rather than
        // attempting a redirect that will be silently swallowed
        if (isInAppBrowser()) {
          resetButton(btn)
          showInAppBrowserBanner(data.url)
          return
        }

        // Normal browser: perform redirect manually and arm a swallowed-redirect
        // guard — if the page is still visible after 3 s, the redirect failed
        window.location.href = data.url

        const oauthUrl = data.url
        const swallowGuard = setTimeout(() => {
          if (!document.hidden) {
            resetButton(btn)
            showInAppBrowserBanner(oauthUrl)
          }
        }, 3000)

        const cancelGuard = () => clearTimeout(swallowGuard)
        document.addEventListener(
          'visibilitychange',
          () => {
            if (document.hidden) cancelGuard()
          },
          { once: true }
        )
        window.addEventListener('pagehide', cancelGuard, { once: true })
      } catch (err) {
        console.error('GitHub login error:', err)
        resetButton(btn)
        // Show error inline rather than alert() — CCTs may block alert()
        const msg = err instanceof Error ? err.message : 'Failed to initiate GitHub login'
        const existing = document.getElementById('ib-banner')
        if (!existing) {
          const errBanner = document.createElement('div')
          errBanner.id = 'ib-banner'
          errBanner.setAttribute(
            'style',
            'position:fixed;bottom:0;left:0;right:0;z-index:9999;' +
              'background:#1a1a1f;border-top:1px solid #2a2a2f;' +
              'padding:1rem 1.25rem;display:flex;justify-content:space-between;align-items:center;gap:1rem;' +
              'font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif'
          )
          errBanner.innerHTML =
            '<p style="margin:0;color:#fafafa;font-size:0.875rem">' +
            '<strong>Sign-in failed:</strong> ' +
            msg.replace(/</g, '&lt;') +
            '</p>' +
            '<button id="ib-dismiss" style="flex-shrink:0;background:transparent;color:#9ca3af;' +
            'border:1px solid #2a2a2f;border-radius:0.375rem;padding:0.5rem 0.75rem;' +
            'font-size:0.875rem;cursor:pointer">Dismiss</button>'
          document.body.appendChild(errBanner)
          document.getElementById('ib-dismiss')?.addEventListener('click', () => {
            errBanner.remove()
          })
        }
      }
    })
  })
</script>
