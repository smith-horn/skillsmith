---
/**
 * UsageDisplay Component
 * SMI-2083: Usage tracking display
 * SMI-2151: ARIA accessibility
 *
 * Displays current billing period API usage with:
 * - Progress bar visualization
 * - Screen reader support
 * - Tier-based quota limits
 */

interface Props {
  /** Current usage count */
  used?: number;
  /** Quota limit based on tier */
  limit?: number;
  /** User's subscription tier */
  tier?: 'community' | 'individual' | 'team' | 'enterprise';
  /** Whether to show loading state */
  loading?: boolean;
}

const { used = 0, limit = 1000, tier = 'community', loading = false } = Astro.props;

// Calculate percentage
const percentage = limit > 0 ? Math.min((used / limit) * 100, 100) : 0;

// Determine color based on usage level
const getProgressColor = (pct: number) => {
  if (pct >= 90) return 'bg-red-500';
  if (pct >= 75) return 'bg-yellow-500';
  return 'bg-primary-500';
};

const progressColor = getProgressColor(percentage);

// Format numbers for display
const formatNumber = (n: number) => new Intl.NumberFormat().format(n);

// Tier display names
const tierNames: Record<string, string> = {
  community: 'Community',
  individual: 'Individual',
  team: 'Team',
  enterprise: 'Enterprise',
};

// ARIA label for screen readers
const ariaLabel = `API usage: ${formatNumber(used)} of ${formatNumber(limit)} requests used this month. ${percentage.toFixed(0)}% of ${tierNames[tier] || tier} tier quota.`;
---

<div
  id="usage-display"
  class="bg-dark-800 rounded-lg p-4 border border-dark-700"
  role="region"
  aria-label="API Usage"
>
  {loading ? (
    <!-- Loading State -->
    <div class="animate-pulse">
      <div class="h-4 bg-dark-700 rounded w-1/3 mb-3"></div>
      <div class="h-2 bg-dark-700 rounded mb-2"></div>
      <div class="h-3 bg-dark-700 rounded w-1/4"></div>
    </div>
  ) : (
    <>
      <!-- Header -->
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-medium text-dark-300">API Usage</h3>
        <span class="text-xs px-2 py-0.5 rounded-full bg-dark-700 text-dark-400">
          {tierNames[tier] || tier} Tier
        </span>
      </div>

      <!-- Progress Bar -->
      <div
        class="h-2 bg-dark-700 rounded-full overflow-hidden mb-2"
        role="progressbar"
        aria-valuenow={used}
        aria-valuemin={0}
        aria-valuemax={limit}
        aria-label={ariaLabel}
      >
        <div
          class={`h-full transition-all duration-500 ease-out ${progressColor}`}
          style={`width: ${percentage}%`}
        ></div>
      </div>

      <!-- Stats -->
      <div class="flex items-center justify-between text-xs">
        <span class="text-dark-400">
          <span class="text-white font-medium">{formatNumber(used)}</span>
          <span class="mx-1">/</span>
          <span>{formatNumber(limit)}</span>
          <span class="ml-1">requests</span>
        </span>
        <span class={percentage >= 90 ? 'text-red-400' : percentage >= 75 ? 'text-yellow-400' : 'text-dark-500'}>
          {percentage.toFixed(0)}% used
        </span>
      </div>

      <!-- Warning for high usage -->
      {percentage >= 90 && (
        <div class="mt-3 flex items-center gap-2 text-xs text-red-400" role="alert">
          <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <span>You're approaching your quota limit</span>
        </div>
      )}

      <!-- Upgrade prompt for non-enterprise -->
      {tier !== 'enterprise' && percentage >= 75 && (
        <a
          href="/pricing"
          class="mt-3 block text-xs text-primary-400 hover:text-primary-300 transition-colors"
        >
          Upgrade for higher limits â†’
        </a>
      )}

      <!-- Screen reader summary -->
      <span class="sr-only">{ariaLabel}</span>
    </>
  )}
</div>

<style>
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
</style>
