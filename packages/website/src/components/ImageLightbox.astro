---
/**
 * ImageLightbox - Fullscreen image viewer for blog diagrams
 * SMI-1757 Wave 3: Accessibility improvements
 *
 * Features:
 * - Click image to open fullscreen overlay
 * - ESC or click outside to close
 * - Keyboard accessible (Tab, Enter, ESC)
 * - Respects prefers-reduced-motion
 */
---

<!-- Lightbox overlay (initially hidden) -->
<div
  id="image-lightbox"
  class="lightbox"
  role="dialog"
  aria-modal="true"
  aria-label="Image viewer"
  hidden
>
  <div class="lightbox-backdrop"></div>
  <div class="lightbox-content">
    <img
      id="lightbox-image"
      src=""
      alt=""
      class="lightbox-img"
    />
    <button
      id="lightbox-close"
      class="lightbox-close"
      aria-label="Close image viewer (Escape)"
      type="button"
    >
      <svg
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        aria-hidden="true"
      >
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>
</div>

<style is:global>
  .lightbox {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
  }

  .lightbox[hidden] {
    display: none;
  }

  .lightbox.is-open {
    opacity: 1;
    visibility: visible;
  }

  .lightbox-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    cursor: pointer;
  }

  .lightbox-content {
    position: relative;
    max-width: 95vw;
    max-height: 95vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .lightbox-img {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
    border-radius: 4px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    transform: scale(0.95);
    transition: transform 0.2s ease;
  }

  .lightbox.is-open .lightbox-img {
    transform: scale(1);
  }

  .lightbox-close {
    position: absolute;
    top: -40px;
    right: 0;
    padding: 8px;
    background: transparent;
    border: none;
    color: white;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s ease;
  }

  .lightbox-close:hover,
  .lightbox-close:focus {
    opacity: 1;
    outline: none;
  }

  .lightbox-close:focus-visible {
    outline: 2px solid #E07A5F;
    outline-offset: 2px;
  }

  /* Respect reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .lightbox,
    .lightbox-img {
      transition: none;
    }
  }
</style>

<script>
  // Image Lightbox functionality
  // Uses astro:page-load instead of DOMContentLoaded so handlers
  // rebind after ClientRouter view transitions (SMI-2500)
  function initLightbox() {
    const lightboxEl = document.getElementById('image-lightbox');
    const lightboxImageEl = document.getElementById('lightbox-image') as HTMLImageElement | null;
    const closeButtonEl = document.getElementById('lightbox-close');

    if (!lightboxEl || !lightboxImageEl || !closeButtonEl) return;

    const lightbox = lightboxEl;
    const lightboxImage = lightboxImageEl;
    const closeButton = closeButtonEl;
    const backdrop = lightbox.querySelector('.lightbox-backdrop');

    let lastFocusedElement: HTMLElement | null = null;

    function openLightbox(imgSrc: string, imgAlt: string, triggerElement: HTMLElement) {
      lastFocusedElement = triggerElement;
      lightboxImage.src = imgSrc;
      lightboxImage.alt = imgAlt;
      lightbox.hidden = false;
      void lightbox.offsetWidth;
      lightbox.classList.add('is-open');
      closeButton.focus();
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      lightbox.classList.remove('is-open');
      document.body.style.overflow = '';
      const elementToFocus = lastFocusedElement;
      setTimeout(() => {
        lightbox.hidden = true;
        lightboxImage.src = '';
        lightboxImage.alt = '';
        if (elementToFocus) {
          elementToFocus.focus();
        }
      }, 200);
      lastFocusedElement = null;
    }

    closeButton.addEventListener('click', closeLightbox);
    backdrop?.addEventListener('click', closeLightbox);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !lightbox.hidden) {
        closeLightbox();
      }
    });

    // Make prose images clickable (skip already-bound images)
    const proseImages = document.querySelectorAll('.prose-content img');
    proseImages.forEach((img) => {
      const imgEl = img as HTMLImageElement;
      if (imgEl.getAttribute('role') === 'button') return;

      imgEl.setAttribute('role', 'button');
      imgEl.setAttribute('tabindex', '0');
      imgEl.setAttribute('aria-label', `${imgEl.alt || 'Image'} - Click to enlarge`);

      imgEl.addEventListener('click', () => {
        openLightbox(imgEl.src, imgEl.alt, imgEl);
      });

      imgEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          openLightbox(imgEl.src, imgEl.alt, imgEl);
        }
      });
    });

    // Add scope to table headers for accessibility
    const tables = document.querySelectorAll('.prose-content table');
    tables.forEach((table) => {
      const headerCells = table.querySelectorAll('th');
      headerCells.forEach((th) => {
        if (!th.hasAttribute('scope')) {
          th.setAttribute('scope', 'col');
        }
      });
    });
  }

  // Fires on initial load AND after ClientRouter view transitions
  document.addEventListener('astro:page-load', initLightbox);
</script>
