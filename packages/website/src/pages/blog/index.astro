---
/**
 * Blog Listing Page
 * SMI-1728: Blog system implementation
 */
import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogPostCard from '../../components/BlogPostCard.astro';
import { getCollection } from 'astro:content';
import { calculateReadingTime } from '../../utils/blog';

// Get all published blog posts, sorted by date (newest first)
const posts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Separate featured and regular posts
const featuredPosts = posts.filter(post => post.data.featured);
const regularPosts = posts.filter(post => !post.data.featured);

// Get unique categories
const categories = [...new Set(posts.map(post => post.data.category).filter(Boolean))];
---

<BaseLayout
  title="Blog | Skillsmith"
  description="Tutorials, guides, and insights about building agent skills for AI assistants"
>
  <!-- JSON-LD for Blog listing -->
  <script type="application/ld+json" slot="head">
    {JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Blog",
      "name": "Skillsmith Blog",
      "description": "Tutorials, guides, and insights about building agent skills for AI assistants",
      "url": "https://skillsmith.app/blog",
      "publisher": {
        "@type": "Organization",
        "name": "Skillsmith",
        "logo": {
          "@type": "ImageObject",
          "url": "https://skillsmith.app/logo-icon.svg"
        }
      },
      "blogPost": posts.map(post => ({
        "@type": "BlogPosting",
        "headline": post.data.title,
        "description": post.data.description,
        "datePublished": post.data.date.toISOString(),
        "author": {
          "@type": "Person",
          "name": post.data.author
        },
        "url": `https://skillsmith.app/blog/${post.slug}`
      }))
    })}
  </script>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <!-- Header -->
    <header class="text-center mb-16">
      <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">
        Skillsmith Blog
      </h1>
      <p class="text-lg text-dark-400 max-w-2xl mx-auto">
        Tutorials, guides, and insights about building agent skills for AI assistants.
        Learn best practices for agent architecture, skill composition, and workflow automation.
      </p>
    </header>

    {posts.length === 0 ? (
      <!-- Empty State -->
      <div class="text-center py-20">
        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-dark-800 flex items-center justify-center">
          <svg class="w-8 h-8 text-dark-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9.5a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
          </svg>
        </div>
        <h2 class="text-xl font-semibold text-white mb-2">Coming Soon</h2>
        <p class="text-dark-400">
          We're working on our first articles. Check back soon!
        </p>
      </div>
    ) : (
      <>
        {/* Featured Posts */}
        {featuredPosts.length > 0 && (
          <section class="mb-16">
            <h2 class="text-sm font-semibold uppercase tracking-wider text-dark-400 mb-6">
              Featured
            </h2>
            <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-1">
              {featuredPosts.map((post) => (
                <BlogPostCard
                  title={post.data.title}
                  description={post.data.description}
                  slug={post.slug}
                  date={post.data.date}
                  author={post.data.author}
                  category={post.data.category}
                  tags={post.data.tags}
                  featured={true}
                  readingTime={calculateReadingTime(post.body ?? '')}
                  ogImage={post.data.ogImage}
                />
              ))}
            </div>
          </section>
        )}

        {/* All Posts */}
        {regularPosts.length > 0 && (
          <section>
            <h2 class="text-sm font-semibold uppercase tracking-wider text-dark-400 mb-6">
              {featuredPosts.length > 0 ? 'All Articles' : 'Articles'}
            </h2>
            <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
              {regularPosts.map((post) => (
                <BlogPostCard
                  title={post.data.title}
                  description={post.data.description}
                  slug={post.slug}
                  date={post.data.date}
                  author={post.data.author}
                  category={post.data.category}
                  tags={post.data.tags}
                  readingTime={calculateReadingTime(post.body ?? '')}
                  ogImage={post.data.ogImage}
                />
              ))}
            </div>
          </section>
        )}

        {/* Categories */}
        {categories.length > 1 && (
          <aside class="mt-16 pt-12 border-t border-dark-800">
            <h2 class="text-sm font-semibold uppercase tracking-wider text-dark-400 mb-4">
              Categories
            </h2>
            <div class="flex flex-wrap gap-2">
              {categories.map((category) => (
                <span class="px-4 py-2 text-sm bg-dark-800 text-dark-300 rounded-lg">
                  {category}
                </span>
              ))}
            </div>
          </aside>
        )}
      </>
    )}
  </div>
</BaseLayout>
