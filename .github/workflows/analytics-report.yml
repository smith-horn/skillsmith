# SMI-2454: Weekly GA4 analytics report via Workload Identity Federation
# Queries Google Analytics Data API and generates a traffic summary
# Auth: GitHub OIDC -> WIF Pool -> Service Account impersonation (no secrets needed)

name: Weekly Analytics Report

on:
  schedule:
    # Every Monday at 9:00 AM UTC (aligned with ops-report and billing-monitor)
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      days:
        description: 'Number of days to include in report'
        required: false
        default: '7'
        type: string
      create_issue:
        description: 'Create GitHub issue with report'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  id-token: write
  issues: write

env:
  # WIF config stored as repository variables (not secrets) since these are
  # non-sensitive infrastructure identifiers. See deployment-guide.md.
  GA4_PROPERTY_ID: ${{ vars.GA4_PROPERTY_ID }}
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
  GCP_SERVICE_ACCOUNT: ${{ vars.GCP_SERVICE_ACCOUNT }}

jobs:
  analytics-report:
    name: Generate Analytics Report
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Variables
        run: |
          MISSING=""
          [ -z "$GA4_PROPERTY_ID" ] && MISSING="$MISSING GA4_PROPERTY_ID"
          [ -z "$GCP_PROJECT_ID" ] && MISSING="$MISSING GCP_PROJECT_ID"
          [ -z "$GCP_WIF_PROVIDER" ] && MISSING="$MISSING GCP_WIF_PROVIDER"
          [ -z "$GCP_SERVICE_ACCOUNT" ] && MISSING="$MISSING GCP_SERVICE_ACCOUNT"
          if [ -n "$MISSING" ]; then
            echo "::error::Missing required repository variables:$MISSING"
            echo "Set these at: Settings > Secrets and variables > Actions > Variables"
            exit 1
          fi
          echo "Variables validated"

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          service_account: ${{ env.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Query GA4 Traffic Data
        id: traffic
        env:
          INPUT_DAYS: ${{ github.event.inputs.days || '7' }}
        run: |
          DAYS="$INPUT_DAYS"

          # Query sessions, users, and engagement by date
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $(gcloud auth print-access-token)" \
            -H "Content-Type: application/json" \
            -d '{
              "dateRanges": [{"startDate": "'"${DAYS}"'daysAgo", "endDate": "today"}],
              "metrics": [
                {"name": "sessions"},
                {"name": "activeUsers"},
                {"name": "screenPageViews"},
                {"name": "averageSessionDuration"},
                {"name": "bounceRate"},
                {"name": "conversions"}
              ],
              "dimensions": [{"name": "date"}],
              "orderBys": [{"dimension": {"dimensionName": "date"}}]
            }' \
            "https://analyticsdata.googleapis.com/v1beta/${GA4_PROPERTY_ID}:runReport")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "::error::GA4 API returned HTTP $HTTP_CODE"
            echo "$BODY" | head -20
            exit 1
          fi

          # Check for API-level errors
          ERROR=$(echo "$BODY" | jq -r '.error.message // empty')
          if [ -n "$ERROR" ]; then
            echo "::error::GA4 API error: $ERROR"
            exit 1
          fi

          # Extract totals from row-level data (guard against empty responses)
          TOTAL_SESSIONS=$(echo "$BODY" | jq -r '[.rows[]?.metricValues[0].value | tonumber] | add // 0')
          TOTAL_USERS=$(echo "$BODY" | jq -r '[.rows[]?.metricValues[1].value | tonumber] | add // 0')
          TOTAL_PAGEVIEWS=$(echo "$BODY" | jq -r '[.rows[]?.metricValues[2].value | tonumber] | add // 0')
          AVG_DURATION=$(echo "$BODY" | jq -r '[.rows[]?.metricValues[3].value | tonumber] | if length == 0 then 0 else (add / length | round) end')
          AVG_BOUNCE=$(echo "$BODY" | jq -r '[.rows[]?.metricValues[4].value | tonumber] | if length == 0 then 0 else (add / length | . * 100 | round / 100) end')
          TOTAL_CONVERSIONS=$(echo "$BODY" | jq -r '[.rows[]?.metricValues[5].value | tonumber] | add // 0')

          echo "sessions=$TOTAL_SESSIONS" >> $GITHUB_OUTPUT
          echo "users=$TOTAL_USERS" >> $GITHUB_OUTPUT
          echo "pageviews=$TOTAL_PAGEVIEWS" >> $GITHUB_OUTPUT
          echo "avg_duration=$AVG_DURATION" >> $GITHUB_OUTPUT
          echo "avg_bounce=$AVG_BOUNCE" >> $GITHUB_OUTPUT
          echo "conversions=$TOTAL_CONVERSIONS" >> $GITHUB_OUTPUT
          echo "days=$DAYS" >> $GITHUB_OUTPUT

      - name: Query Top Pages
        id: pages
        env:
          INPUT_DAYS: ${{ github.event.inputs.days || '7' }}
        run: |
          DAYS="$INPUT_DAYS"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $(gcloud auth print-access-token)" \
            -H "Content-Type: application/json" \
            -d '{
              "dateRanges": [{"startDate": "'"${DAYS}"'daysAgo", "endDate": "today"}],
              "metrics": [
                {"name": "sessions"},
                {"name": "screenPageViews"}
              ],
              "dimensions": [{"name": "pagePath"}],
              "orderBys": [{"metric": {"metricName": "sessions"}, "desc": true}],
              "limit": 10
            }' \
            "https://analyticsdata.googleapis.com/v1beta/${GA4_PROPERTY_ID}:runReport")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "::error::GA4 Top Pages API returned HTTP $HTTP_CODE"
            exit 1
          fi

          # Build markdown table of top pages
          TABLE="| Page | Sessions | Page Views |\n|------|----------|------------|\n"
          TABLE+=$(echo "$BODY" | jq -r '.rows[]? | "| \(.dimensionValues[0].value) | \(.metricValues[0].value) | \(.metricValues[1].value) |"')

          printf '%b\n' "$TABLE" > /tmp/top-pages.md

      - name: Query Traffic Sources
        id: sources
        env:
          INPUT_DAYS: ${{ github.event.inputs.days || '7' }}
        run: |
          DAYS="$INPUT_DAYS"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $(gcloud auth print-access-token)" \
            -H "Content-Type: application/json" \
            -d '{
              "dateRanges": [{"startDate": "'"${DAYS}"'daysAgo", "endDate": "today"}],
              "metrics": [
                {"name": "sessions"},
                {"name": "activeUsers"}
              ],
              "dimensions": [{"name": "sessionDefaultChannelGroup"}],
              "orderBys": [{"metric": {"metricName": "sessions"}, "desc": true}],
              "limit": 10
            }' \
            "https://analyticsdata.googleapis.com/v1beta/${GA4_PROPERTY_ID}:runReport")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "::error::GA4 Traffic Sources API returned HTTP $HTTP_CODE"
            exit 1
          fi

          TABLE="| Channel | Sessions | Users |\n|---------|----------|-------|\n"
          TABLE+=$(echo "$BODY" | jq -r '.rows[]? | "| \(.dimensionValues[0].value) | \(.metricValues[0].value) | \(.metricValues[1].value) |"')

          printf '%b\n' "$TABLE" > /tmp/traffic-sources.md

      - name: Generate Summary
        run: |
          DAYS="${{ steps.traffic.outputs.days }}"

          echo "### Weekly Analytics Report (Last ${DAYS} Days)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Sessions | ${{ steps.traffic.outputs.sessions }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Active Users | ${{ steps.traffic.outputs.users }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Page Views | ${{ steps.traffic.outputs.pageviews }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Avg Session Duration | ${{ steps.traffic.outputs.avg_duration }}s |" >> $GITHUB_STEP_SUMMARY
          echo "| Bounce Rate | ${{ steps.traffic.outputs.avg_bounce }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Conversions | ${{ steps.traffic.outputs.conversions }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "#### Top Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat /tmp/top-pages.md >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "#### Traffic Sources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat /tmp/traffic-sources.md >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Report generated: $(date -u +%Y-%m-%dT%H:%M:%SZ) | GA4 Property: ${GA4_PROPERTY_ID} | Auth: Workload Identity Federation*" >> $GITHUB_STEP_SUMMARY

      - name: Ensure analytics label exists
        if: github.event.inputs.create_issue == 'true'
        run: |
          gh label create analytics --color "4A90D9" --description "Analytics reports and metrics" 2>/dev/null || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create issue if requested
        if: github.event.inputs.create_issue == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPORT_DAYS: ${{ steps.traffic.outputs.days }}
          REPORT_SESSIONS: ${{ steps.traffic.outputs.sessions }}
          REPORT_USERS: ${{ steps.traffic.outputs.users }}
          REPORT_PAGEVIEWS: ${{ steps.traffic.outputs.pageviews }}
          REPORT_DURATION: ${{ steps.traffic.outputs.avg_duration }}
          REPORT_BOUNCE: ${{ steps.traffic.outputs.avg_bounce }}
          REPORT_CONVERSIONS: ${{ steps.traffic.outputs.conversions }}
        run: |
          GENERATED=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          TITLE="Analytics Report - $(date +%Y-%m-%d) (${REPORT_DAYS}d)"

          BODY="## Analytics Report

          **Period**: Last ${REPORT_DAYS} days
          **Generated**: ${GENERATED}

          ### Overview

          | Metric | Value |
          |--------|-------|
          | Sessions | ${REPORT_SESSIONS} |
          | Active Users | ${REPORT_USERS} |
          | Page Views | ${REPORT_PAGEVIEWS} |
          | Avg Session Duration | ${REPORT_DURATION}s |
          | Bounce Rate | ${REPORT_BOUNCE}% |
          | Conversions | ${REPORT_CONVERSIONS} |

          ### Top Pages

          "

          BODY+=$(cat /tmp/top-pages.md)
          BODY+=$'\n\n### Traffic Sources\n\n'
          BODY+=$(cat /tmp/traffic-sources.md)
          BODY+=$'\n\n---\n*Auto-generated by analytics-report workflow*'

          gh issue create \
            --title "$TITLE" \
            --body "$BODY" \
            --label "analytics"

      - name: Report Failure
        if: failure() || cancelled()
        run: |
          echo "### Analytics Report Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          echo "Common issues:" >> $GITHUB_STEP_SUMMARY
          echo "- Repository variables not set (Settings > Actions > Variables)" >> $GITHUB_STEP_SUMMARY
          echo "- WIF provider misconfigured" >> $GITHUB_STEP_SUMMARY
          echo "- Service account lacks GA4 Viewer role" >> $GITHUB_STEP_SUMMARY
          echo "- GA4 Data API not enabled in GCP project" >> $GITHUB_STEP_SUMMARY
