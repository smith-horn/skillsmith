# SMI-1248: GitHub Actions workflow for scheduled skill indexing
# Alternative to pg_cron for triggering the indexer
#
# Performance Notes (SMI-1413):
# - Edge Function has 150-second timeout
# - max_pages=5 indexes ~400 skills reliably (~1 min)
# - max_pages=7+ causes timeout (502 Bad Gateway)
# - Uses GitHub App auth for 5000 req/hour rate limit
#
# Phase 1b: 4x daily runs with advisory lock
# - 00:00 UTC = maintenance (stale cleanup, stale_days=3)
# - 06:00, 12:00, 18:00 UTC = discovery (new skills, stale_days=30)

name: Skill Indexer

on:
  schedule:
    # Phase 1b: Run 4x daily instead of 1x
    - cron: '0 0,6,12,18 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no database writes)'
        required: false
        default: 'false'
        type: boolean
      max_pages:
        description: 'Max pages per topic (5 recommended, 7+ causes timeout)'
        required: false
        default: '5'
        type: string
      run_type:
        description: 'Run type: maintenance (stale cleanup) or discovery (new skills)'
        required: false
        default: 'discovery'
        type: choice
        options:
          - discovery
          - maintenance
      stale_days:
        description: 'Days before stale quarantine (default: auto based on run_type)'
        required: false
        default: ''
        type: string

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

jobs:
  index:
    name: Index GitHub Skills
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions: {}

    steps:
      - name: Validate Secrets
        run: |
          # SMI-1313: Fail fast with clear error if secrets not configured
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "::error::Required secrets not configured. Add SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY to repository secrets."
            echo "See: https://github.com/wrsmith108/skillsmith/settings/secrets/actions"
            exit 1
          fi
          echo "Secrets validated"

      - name: Determine Run Type
        id: config
        run: |
          # For scheduled runs, determine run type based on UTC hour
          if [ "${{ github.event_name }}" = "schedule" ]; then
            HOUR=$(date -u +%H)
            if [ "$HOUR" = "00" ]; then
              RUN_TYPE="maintenance"
              STALE_DAYS="3"
            else
              RUN_TYPE="discovery"
              STALE_DAYS="30"
            fi
          else
            # Manual dispatch uses inputs
            RUN_TYPE="${{ github.event.inputs.run_type || 'discovery' }}"
            STALE_DAYS="${{ github.event.inputs.stale_days }}"
            if [ -z "$STALE_DAYS" ]; then
              if [ "$RUN_TYPE" = "maintenance" ]; then
                STALE_DAYS="3"
              else
                STALE_DAYS="30"
              fi
            fi
          fi
          echo "run_type=$RUN_TYPE" >> $GITHUB_OUTPUT
          echo "stale_days=$STALE_DAYS" >> $GITHUB_OUTPUT
          echo "Run type: $RUN_TYPE, Stale days: $STALE_DAYS"

      - name: Trigger Indexer
        id: indexer
        run: |
          # Build request body
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          MAX_PAGES="${{ github.event.inputs.max_pages || '5' }}"
          RUN_TYPE="${{ steps.config.outputs.run_type }}"
          STALE_DAYS="${{ steps.config.outputs.stale_days }}"

          BODY=$(cat <<EOF
          {
            "maxPages": $MAX_PAGES,
            "dryRun": $DRY_RUN,
            "runType": "$RUN_TYPE",
            "staleThresholdDays": $STALE_DAYS
          }
          EOF
          )

          echo "Triggering indexer with: $BODY"

          # Call the Edge Function
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -d "$BODY" \
            "$SUPABASE_URL/functions/v1/indexer")

          # Extract status code and body
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response code: $HTTP_CODE"
          echo "Response body: $BODY"

          # Set outputs
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "response=$BODY" >> $GITHUB_OUTPUT

          # Check for success (200 = normal, skipped runs from advisory lock are OK)
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "::error::Indexer failed with status $HTTP_CODE"
            exit 1
          fi

          # Check if run was skipped due to concurrent execution
          SKIPPED=$(echo "$BODY" | jq -r '.data.skipped // false')
          if [ "$SKIPPED" = "true" ]; then
            echo "::notice::Run skipped - concurrent indexer already in progress"
          fi

      - name: Parse Results
        if: success()
        run: |
          RESPONSE='${{ steps.indexer.outputs.response }}'

          # Extract metrics using jq
          FOUND=$(echo "$RESPONSE" | jq -r '.data.found // 0')
          INDEXED=$(echo "$RESPONSE" | jq -r '.data.indexed // 0')
          FAILED=$(echo "$RESPONSE" | jq -r '.data.failed // 0')
          STALE=$(echo "$RESPONSE" | jq -r '.data.stale // 0')
          UNCHANGED=$(echo "$RESPONSE" | jq -r '.data.unchanged // 0')
          CODE_SEARCH=$(echo "$RESPONSE" | jq -r '.data.code_search.repos_found // 0')
          DRY_RUN=$(echo "$RESPONSE" | jq -r '.data.dryRun // false')
          RUN_TYPE="${{ steps.config.outputs.run_type }}"

          echo "### Indexer Results ($RUN_TYPE)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Found | $FOUND |" >> $GITHUB_STEP_SUMMARY
          echo "| Indexed (new) | $INDEXED |" >> $GITHUB_STEP_SUMMARY
          echo "| Unchanged | $UNCHANGED |" >> $GITHUB_STEP_SUMMARY
          echo "| Stale Quarantined | $STALE |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Search Repos | $CODE_SEARCH |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | $DRY_RUN |" >> $GITHUB_STEP_SUMMARY

      - name: Report Failure
        if: failure()
        run: |
          echo "### Indexer Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "HTTP Code: ${{ steps.indexer.outputs.http_code }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Response: \`${{ steps.indexer.outputs.response }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Send Alert on Failure
        if: failure()
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "type": "indexer_failed",
              "message": "The skill indexer workflow failed. HTTP Code: ${{ steps.indexer.outputs.http_code }}",
              "workflow": "Skill Indexer",
              "runId": "${{ github.run_id }}",
              "runUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }' \
            "$SUPABASE_URL/functions/v1/alert-notify" || true
