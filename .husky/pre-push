# Pre-push hook: Shift-left quality gates
# Issues: SMI-727, SMI-1342, SMI-1835, SMI-2166
#
# This hook runs quality checks before allowing a push to remote:
#   1. Warns about uncommitted changes (SMI-1342)
#   2. Security checks (SMI-727)
#   3. Format check (SMI-1835) - catches Prettier issues before CI
#   4. Coverage check (SMI-1602)
#
# Configuration:
#   --no-verify  - Skip all hooks (use with caution): git push --no-verify
#
# Checks performed:
#   Phase 1 (SMI-1342): Uncommitted changes detection
#     - Staged changes (added but not committed)
#     - Unstaged changes (modified but not added)
#     - Untracked files (new files not in git)
#   Phase 2 (SMI-727): Security checks
#     - Security test suite (packages/core/tests/security/)
#     - npm audit (high severity or above)
#     - Hardcoded secrets pattern detection
#   Phase 3 (SMI-1835): Format check
#     - Prettier formatting across entire codebase
#   Phase 4 (SMI-1602): Coverage check
#     - Test coverage thresholds
#   Phase 5 (SMI-2633): Linear issue sync (non-blocking)
#     - Syncs unpushed commits with Linear issues
#     - Marks issues as "in_review" before push
#
# Exit codes:
#   0 - All checks passed (or user confirmed)
#   1 - Check failed or user aborted

# Phase 1: Check for uncommitted changes (SMI-1342)
# This runs first to warn developers before they push
bash "$(dirname "$0")/../scripts/pre-push-uncommitted-check.sh"
UNCOMMITTED_STATUS=$?

# If user chose to abort, stop here
if [ $UNCOMMITTED_STATUS -ne 0 ]; then
  exit 1
fi

# Phase 2: Run security checks (SMI-727)
bash "$(dirname "$0")/../scripts/pre-push-check.sh"
SECURITY_STATUS=$?

if [ $SECURITY_STATUS -ne 0 ]; then
  exit 1
fi

# Phase 3: Format check (SMI-1835 follow-up)
# Catches Prettier issues before they hit CI - shift left approach
echo "üîç Running pre-push format check..."

# Check if Docker is available
# SMI-1774: Use -w /app to support running from worktree directories
if ! docker exec -w /app skillsmith-dev-1 echo "ok" > /dev/null 2>&1; then
  echo "‚ö†Ô∏è  Docker not running - skipping format check"
  echo "   Run: docker compose --profile dev up -d"
  exit 0  # Don't block push, just warn
fi

# Run format check
if docker exec -w /app skillsmith-dev-1 npm run format:check > /dev/null 2>&1; then
  echo "‚úÖ Format check passed"
else
  echo ""
  echo "‚ùå Prettier formatting issues found!"
  echo "   Run: docker exec skillsmith-dev-1 npm run format"
  echo "   to auto-fix, then commit and push again"
  echo ""
  echo "   Bypass: git push --no-verify"
  exit 1
fi

# Phase 4: Coverage validation (SMI-1602 follow-up, SMI-2166 improvements)
# Catches coverage issues before code leaves local machine
echo "üîç Running pre-push coverage check..."

# Docker already confirmed available in Phase 3

# Run coverage check and capture output for better diagnostics (SMI-2166)
# SMI-1774: Use -w /app to support running from worktree directories
COVERAGE_OUTPUT=$(docker exec -w /app skillsmith-dev-1 npm run test:coverage 2>&1)
COVERAGE_STATUS=$?

if [ $COVERAGE_STATUS -eq 0 ]; then
  echo "‚úÖ Coverage check passed"
else
  echo ""

  # SMI-2166: Detect specific failure types and provide targeted help
  if echo "$COVERAGE_OUTPUT" | grep -q "better_sqlite3\|ERR_DLOPEN_FAILED\|NODE_MODULE_VERSION"; then
    echo "‚ùå Native module error detected!"
    echo "   The better-sqlite3 module needs to be rebuilt."
    echo ""
    echo "   Fix: docker exec skillsmith-dev-1 npm rebuild better-sqlite3"
    echo "   Then try pushing again."
  elif echo "$COVERAGE_OUTPUT" | grep -q "FAIL.*test\|failed.*test"; then
    echo "‚ùå Tests failed!"
    echo "   Run: docker exec skillsmith-dev-1 npm test"
    echo "   to see which tests are failing"
  elif echo "$COVERAGE_OUTPUT" | grep -q "threshold\|below.*%"; then
    echo "‚ùå Coverage threshold not met!"
    echo "   Run: docker exec skillsmith-dev-1 npm run test:coverage"
    echo "   to see detailed coverage report"
  else
    echo "‚ùå Coverage check failed!"
    echo "   Run: docker exec skillsmith-dev-1 npm run test:coverage"
    echo "   to see detailed report"
  fi

  echo ""
  echo "   Bypass: git push --no-verify"
  exit 1
fi

# Phase 5: Linear issue sync (non-blocking, SMI-2633)
# Syncs SMI-* references from unpushed commits to Linear
echo "üîÑ Syncing Linear issues..."
node "$(dirname "$0")/../scripts/linear-hook.mjs" --batch || echo "‚ö†Ô∏è  Linear sync skipped (non-blocking)"

exit 0
