#!/bin/sh
# Post-merge hook
# - SMI-2552: Auto-install npm dependencies when package-lock.json changes
# Fires after git pull (merge) and git merge. Non-blocking â€” cannot abort.

# Color codes (match pre-commit style)
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

DOCKER_CONTAINER="skillsmith-dev-1"

# Check if package-lock.json changed in the merge
# ORIG_HEAD = tip before merge, HEAD = after merge
if git diff --name-only ORIG_HEAD HEAD | grep -q '^package-lock\.json$'; then
  echo ""
  echo "${BLUE}=== Post-Merge: package-lock.json changed ===${NC}"
  echo ""

  # Check if Docker container is running
  if command -v docker > /dev/null 2>&1 && \
     docker ps --format '{{.Names}}' 2>/dev/null | grep -q "^${DOCKER_CONTAINER}$"; then
    echo "${YELLOW}Installing updated dependencies in Docker...${NC}"
    if docker exec -w /app "$DOCKER_CONTAINER" npm install; then
      echo "${GREEN}  Dependencies updated successfully.${NC}"
    else
      echo "${YELLOW}  npm install failed. Run manually:${NC}"
      echo "    docker exec $DOCKER_CONTAINER npm install"
    fi
  else
    echo "${YELLOW}Docker container '${DOCKER_CONTAINER}' is not running.${NC}"
    echo "  Start it and install deps:"
    echo "    docker compose --profile dev up -d"
    echo "    docker exec $DOCKER_CONTAINER npm install"
  fi

  echo ""
fi

exit 0
